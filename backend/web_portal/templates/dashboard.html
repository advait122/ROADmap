{% extends "base.html" %}
{% block title %}Dashboard | CodeMap{% endblock %}
{% block body_class %}dashboard-page{% endblock %}
{% block page_styles %}
<link href="/static/css/dashboard.css?v={{ asset_version }}" rel="stylesheet">
{% endblock %}
{% block content %}
{% set section = active_section if active_section else "roadmap" %}
{% if section == "roadmap" %}
{% set completed_goal_names = dashboard.goal_skills
    | selectattr("status", "equalto", "completed")
    | map(attribute="skill_name")
    | map("lower")
    | list
%}
<section class="roadmap-view mb-4">
    <article class="page-card roadmap-hero-card">
        <div class="roadmap-hero-content">
            <div class="roadmap-hero-main">
                <p class="roadmap-hero-kicker">Current Goal</p>
                <h2 class="roadmap-hero-title">{{ dashboard.goal.goal_text }}</h2>
                <div class="roadmap-hero-meta">
                    <span class="roadmap-hero-meta-item">
                        <svg class="roadmap-meta-icon" viewBox="0 0 24 24" aria-hidden="true">
                            <rect x="3.5" y="4.5" width="17" height="16" rx="2.4"></rect>
                            <line x1="8" y1="3" x2="8" y2="7"></line>
                            <line x1="16" y1="3" x2="16" y2="7"></line>
                            <line x1="3.5" y1="9" x2="20.5" y2="9"></line>
                            <rect x="7.1" y="11.8" width="2.4" height="2.4" rx="0.45"></rect>
                            <rect x="10.8" y="11.8" width="2.4" height="2.4" rx="0.45"></rect>
                            <rect x="14.5" y="11.8" width="2.4" height="2.4" rx="0.45"></rect>
                        </svg>
                        Target: {{ dashboard.goal_target_date_display }}
                    </span>
                    {% if dashboard.goal_months_remaining is not none %}
                        <span class="roadmap-hero-meta-item">
                            <svg class="roadmap-meta-icon" viewBox="0 0 24 24" aria-hidden="true">
                                <path d="M7 3.5h10"></path>
                                <path d="M7 20.5h10"></path>
                                <path d="M8.2 3.5v3.2c0 1.8.98 3.45 2.58 4.37L12 11.75l1.22-.68c1.6-.92 2.58-2.57 2.58-4.37V3.5"></path>
                                <path d="M8.2 20.5v-3.2c0-1.8.98-3.45 2.58-4.37L12 12.25l1.22.68c1.6.92 2.58 2.57 2.58 4.37v3.2"></path>
                            </svg>
                            {{ dashboard.goal_months_remaining }} month{% if dashboard.goal_months_remaining != 1 %}s{% endif %} remaining
                        </span>
                    {% endif %}
                </div>
            </div>
            <div class="roadmap-hero-side">
                <div class="roadmap-hero-status">Active Goal</div>
            </div>
        </div>

        {% if error %}
            <div class="alert alert-danger mt-3 mb-0">{{ error }}</div>
        {% endif %}
        {% if dashboard.replan_info.applied %}
            <div class="alert alert-warning mt-3 mb-0">
                Roadmap auto-adjusted because {{ dashboard.replan_info.overdue_task_count }} task(s) were missed.
                {{ dashboard.replan_info.updated_task_count }} task(s) were rescheduled.
            </div>
        {% endif %}
    </article>

    <section class="roadmap-top-grid">
        <article class="page-card roadmap-progress-card-dark">
            <h3 class="roadmap-progress-heading">Progress</h3>
            <div class="roadmap-progress-body">
                <div class="roadmap-progress-ring" style="--progress-value: {{ '%.2f'|format(dashboard.progress.completion_percent) }};">
                    <div class="roadmap-progress-ring-center">
                        <span class="roadmap-progress-ring-main">{{ dashboard.progress.completed_tasks }}</span>
                        <span class="roadmap-progress-ring-sub">of {{ dashboard.progress.total_tasks }}</span>
                    </div>
                </div>
                <div class="roadmap-progress-copy">
                    <p class="roadmap-progress-percent">{{ "%.0f"|format(dashboard.progress.completion_percent) }}%</p>
                    <p class="roadmap-progress-label">Task Completion</p>
                    <div class="roadmap-progress-track">
                        <div class="roadmap-progress-fill" style="--progress-value: {{ '%.2f'|format(dashboard.progress.completion_percent) }};"></div>
                    </div>
                </div>
            </div>
        </article>

        <article class="page-card roadmap-panel-card">
            <h3 class="roadmap-panel-ribbon">Skill Gap</h3>
            {% if dashboard.goal_skills %}
                <div class="roadmap-chip-list">
                    {% for skill in dashboard.goal_skills %}
                        <span class="roadmap-chip
                            {% if skill.status == 'completed' %}is-completed{% endif %}
                            {% if skill.is_locked %}is-locked{% endif %}
                        ">
                            {% if skill.is_locked %}<span class="roadmap-chip-icon" aria-hidden="true">&#128274;</span>{% endif %}
                            {{ skill.skill_name }}
                            {% if skill.status == "completed" %}<span class="roadmap-chip-icon roadmap-chip-check" aria-hidden="true">&#10003;</span>{% endif %}
                        </span>
                    {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-success mb-0">You currently meet all extracted requirements.</div>
            {% endif %}
        </article>

        <article class="page-card roadmap-panel-card">
            <h3 class="roadmap-panel-ribbon">Required Skills (LLM + Opportunity)</h3>
            {% if dashboard.required_skills %}
                <div class="roadmap-chip-list">
                    {% for skill in dashboard.required_skills %}
                        <span class="roadmap-chip">{{ skill }}</span>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted mb-0">No required skills extracted.</p>
            {% endif %}
        </article>
    </section>

    <article class="page-card roadmap-panel-card roadmap-current-card">
        <h3 class="roadmap-panel-ribbon">Your Current Skills</h3>
        {% if dashboard.known_skills %}
            <div class="roadmap-chip-list">
                {% for skill in dashboard.known_skills %}
                    {% set skill_key = skill | lower %}
                    <span class="roadmap-chip {% if skill_key in completed_goal_names %}is-completed{% endif %}">
                        {{ skill }}
                        {% if skill_key in completed_goal_names %}<span class="roadmap-chip-icon roadmap-chip-check" aria-hidden="true">&#10003;</span>{% endif %}
                    </span>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-muted mb-0">No profile skills found.</p>
        {% endif %}
    </article>
</section>
{% endif %}

{% if section != "roadmap" and error %}
<section class="page-card p-3 mb-4">
    <div class="alert alert-danger mb-0">{{ error }}</div>
</section>
{% endif %}

{% if dashboard.company_job_invites %}
<section class="page-card p-3 mb-4">
    <h3 class="h6 mb-3">Company Invitations</h3>
    <div class="company-invite-grid">
        {% for invite in dashboard.company_job_invites %}
            <article class="company-invite-card">
                <div class="company-invite-head">
                    <h4 class="company-invite-title mb-0">{{ invite.title }}</h4>
                    <span class="company-invite-company">{{ invite.company_username }}</span>
                </div>
                <p class="company-invite-copy">{{ invite.job_description }}</p>
                <div class="company-invite-meta">
                    <span><strong>Skills:</strong> {{ invite.required_skill_labels | join(", ") }}</span>
                    <span><strong>Min CGPA:</strong> {{ "%.1f"|format(invite.min_cgpa) }}</span>
                    <span><strong>Deadline:</strong> {{ invite.application_deadline }}</span>
                </div>
                {% if invite.deadline_passed %}
                    <p class="text-danger small mb-0 mt-2">This invitation has expired.</p>
                {% else %}
                    <div class="company-invite-actions">
                        <form
                            method="post"
                            action="/students/{{ student.id }}/company-jobs/{{ invite.job_id }}/respond?section={{ section }}"
                        >
                            <input type="hidden" name="decision" value="apply">
                            <button type="submit" class="btn btn-sm replan-btn">Apply</button>
                        </form>
                        <form
                            method="post"
                            action="/students/{{ student.id }}/company-jobs/{{ invite.job_id }}/respond?section={{ section }}"
                        >
                            <input type="hidden" name="decision" value="decline">
                            <button type="submit" class="btn btn-sm btn-outline-secondary">Decline</button>
                        </form>
                    </div>
                {% endif %}
            </article>
        {% endfor %}
    </div>
</section>
{% endif %}

{% if section == "tasks" %}
{% set active_goal_skill = (dashboard.goal_skills | selectattr('is_active') | list | first) %}
{% if active_goal_skill and active_goal_skill.ready_for_test %}
<section class="page-card p-3 mb-4">
    <div class="alert alert-warning mb-0">
        Give test to proceed further.
    </div>
</section>
{% endif %}

<section id="tasks" class="page-card p-4 mb-4">
    <div class="tasks-section-ribbon">Upcoming Tasks</div>
    {% if dashboard.active_skill and not dashboard.selected_playlist %}
        <div class="alert alert-info">
            Select one playlist for <strong>{{ dashboard.active_skill.skill_name }}</strong> first.
            Task completion will unlock after selection.
        </div>
    {% elif dashboard.upcoming_tasks %}
        <div id="tasksTimeline" class="tasks-timeline">
            <div class="tasks-timeline-track">
                {% set open_state = namespace(default_open_done=False) %}
                {% for task in dashboard.upcoming_tasks %}
                    {% set date_parts = (task.task_date | string).split('-') %}
                    {% if date_parts | length == 3 %}
                        {% set date_label = date_parts[2] ~ '/' ~ date_parts[1] ~ '/' ~ date_parts[0][-2:] %}
                    {% else %}
                        {% set date_label = task.task_date %}
                    {% endif %}

                    {% set details = namespace(url="", watch="", playlist="", channel="", extras=[]) %}
                    {% for raw_line in (task.description or "").split('\n') %}
                        {% set line = raw_line.strip() %}
                        {% if line %}
                            {% if line.lower().startswith('url:') %}
                                {% set details.url = line[4:].strip() %}
                            {% elif line.lower().startswith('watch videos') %}
                                {% if ':' in line %}
                                    {% set details.watch = line.split(':', 1)[1].strip() %}
                                {% else %}
                                    {% set details.watch = line[12:].strip() %}
                                {% endif %}
                            {% elif line.lower().startswith('playlist:') %}
                                {% set details.playlist = line[9:].strip() %}
                            {% elif line.lower().startswith('channel:') %}
                                {% set details.channel = line[8:].strip() %}
                            {% else %}
                                {% set _ = details.extras.append(line) %}
                            {% endif %}
                        {% endif %}
                    {% endfor %}

                    {% set open_default = false %}
                    {% if not open_state.default_open_done and task.task_date == dashboard.today %}
                        {% set open_default = true %}
                        {% set open_state.default_open_done = true %}
                    {% elif not open_state.default_open_done and loop.first %}
                        {% set open_default = true %}
                        {% set open_state.default_open_done = true %}
                    {% endif %}

                    <article class="task-node{% if open_default %} is-open{% endif %}" data-task-node data-task-id="{{ task.id }}">
                        <button
                            type="button"
                            class="task-date-rect{% if open_default %} is-active{% endif %}{% if task.is_completed == 1 %} is-done{% endif %}"
                            data-task-toggle
                            aria-expanded="{{ 'true' if open_default else 'false' }}"
                            aria-controls="task-card-{{ task.id }}"
                        >
                            {{ date_label }}
                        </button>

                        <section
                            id="task-card-{{ task.id }}"
                            class="task-detail-panel{% if open_default %} is-visible{% endif %}"
                            data-task-panel
                            {% if not open_default %}hidden{% endif %}
                        >
                            <header class="task-detail-header">
                                <h4 class="task-detail-title mb-0">{{ task.title }}</h4>
                            </header>

                            <div class="task-detail-body">
                                <div class="task-detail-topline">
                                    <span class="task-detail-target"><strong>TARGET:</strong> {{ task.target_minutes }} min</span>
                                </div>

                                {% if details.watch %}
                                    <p class="task-detail-row">
                                        <span class="task-detail-key">WATCH VIDEOS:</span>
                                        <span class="task-detail-value">{{ details.watch }}</span>
                                    </p>
                                {% endif %}

                                {% if details.playlist %}
                                    <p class="task-detail-row">
                                        <span class="task-detail-key">PLAYLIST:</span>
                                        <span class="task-detail-value">{{ details.playlist }}</span>
                                    </p>
                                {% endif %}

                                {% if details.channel %}
                                    <p class="task-detail-row">
                                        <span class="task-detail-key">CHANNEL:</span>
                                        <span class="task-detail-value">{{ details.channel }}</span>
                                    </p>
                                {% endif %}

                                {% if details.extras %}
                                    {% for line in details.extras %}
                                        <p class="task-detail-line">{{ line }}</p>
                                    {% endfor %}
                                {% endif %}

                                {% if not details.watch and not details.playlist and not details.channel and not details.extras %}
                                    <p class="task-detail-line">No details are available for this task.</p>
                                {% endif %}

                                <div class="task-detail-actions">
                                    {% if details.url %}
                                        <a href="{{ details.url }}" target="_blank" rel="noreferrer" class="btn btn-sm replan-btn task-playlist-btn">
                                            Open Playlist
                                        </a>
                                    {% else %}
                                        <span></span>
                                    {% endif %}

                                    <form
                                        method="post"
                                        action="/students/{{ student.id }}/tasks/{{ task.id }}/completion?section=tasks"
                                        class="task-detail-action"
                                        data-task-complete-form
                                    >
                                        <input type="hidden" name="is_completed" value="{% if task.is_completed == 1 %}0{% else %}1{% endif %}">
                                        <button type="submit" class="btn btn-sm {% if task.is_completed == 1 %}btn-success{% else %}btn-outline-primary{% endif %}">
                                            {% if task.is_completed == 1 %}Done{% else %}Mark Done{% endif %}
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </section>
                    </article>
                {% endfor %}
            </div>
        </div>
    {% else %}
        <p class="text-muted mb-0">No tasks in current window.</p>
    {% endif %}
</section>

{% if dashboard.upcoming_tasks %}
<script>
    (function () {
        const activeKey = "tasksTimeline.activeTaskId";
        const timeline = document.getElementById("tasksTimeline");
        if (!timeline) return;

        const entries = Array.from(timeline.querySelectorAll("[data-task-node]")).map((node) => {
            return {
                taskId: node.getAttribute("data-task-id"),
                node,
                toggle: node.querySelector("[data-task-toggle]"),
                panel: node.querySelector("[data-task-panel]"),
                form: node.querySelector("[data-task-complete-form]"),
            };
        }).filter((item) => item.toggle && item.panel && item.taskId);

        if (!entries.length) return;

        function syncOrigin(item) {
            const { toggle, panel } = item;
            const panelRect = panel.getBoundingClientRect();
            const toggleRect = toggle.getBoundingClientRect();
            if (!panelRect.width || !panelRect.height || !toggleRect.width || !toggleRect.height) return;
            const originX = toggleRect.left + (toggleRect.width / 2) - panelRect.left;
            const originY = toggleRect.top + (toggleRect.height / 2) - panelRect.top;
            panel.style.setProperty("--task-origin-x", `${originX}px`);
            panel.style.setProperty("--task-origin-y", `${originY}px`);
        }

        function syncAllOrigins() {
            entries.forEach(syncOrigin);
        }

        function openEntry(item) {
            const { node, toggle, panel } = item;
            panel.hidden = false;
            panel.classList.remove("closing");
            syncOrigin(item);
            window.requestAnimationFrame(() => {
                syncOrigin(item);
                void panel.offsetWidth;
                panel.classList.add("is-visible");
                node.classList.add("is-open");
                toggle.classList.add("is-active");
                toggle.setAttribute("aria-expanded", "true");
                window.sessionStorage.setItem(activeKey, item.taskId);
            });
        }

        function closeEntry(item) {
            return new Promise((resolve) => {
                const { node, toggle, panel } = item;
                if (panel.hidden || panel.classList.contains("closing")) {
                    resolve();
                    return;
                }

                panel.classList.remove("is-visible");
                panel.classList.add("closing");
                node.classList.remove("is-open");
                toggle.classList.remove("is-active");
                toggle.setAttribute("aria-expanded", "false");

                panel.addEventListener(
                    "animationend",
                    (event) => {
                        if (event.animationName !== "task-detail-panel-close") return;
                        panel.hidden = true;
                        panel.classList.remove("closing");
                        resolve();
                    },
                    { once: true },
                );
            });
        }

        function setActiveInstant(item) {
            entries.forEach((entry) => {
                const isTarget = entry === item;
                entry.panel.classList.remove("closing");
                entry.panel.classList.toggle("is-visible", isTarget);
                entry.panel.hidden = !isTarget;
                entry.node.classList.toggle("is-open", isTarget);
                entry.toggle.classList.toggle("is-active", isTarget);
                entry.toggle.setAttribute("aria-expanded", isTarget ? "true" : "false");
            });
            if (item) {
                syncOrigin(item);
                window.sessionStorage.setItem(activeKey, item.taskId);
            }
        }

        const savedTaskId = window.sessionStorage.getItem(activeKey);
        let activeEntry =
            entries.find((item) => item.taskId === savedTaskId) ||
            entries.find((item) => item.panel.classList.contains("is-visible")) ||
            entries[0];

        if (activeEntry) {
            setActiveInstant(activeEntry);
        }

        entries.forEach((item) => {
            item.toggle.addEventListener("click", async () => {
                if (item === activeEntry && item.panel.classList.contains("is-visible")) return;
                if (activeEntry && activeEntry !== item) {
                    await closeEntry(activeEntry);
                }
                openEntry(item);
                activeEntry = item;
            });

            item.form?.addEventListener("submit", async (event) => {
                event.preventDefault();
                const hiddenInput = item.form.querySelector("input[name='is_completed']");
                const submitBtn = item.form.querySelector("button[type='submit']");
                if (!hiddenInput || !submitBtn) {
                    item.form.submit();
                    return;
                }

                const pendingValue = hiddenInput.value;
                submitBtn.disabled = true;
                item.toggle.disabled = true;

                try {
                    const response = await fetch(item.form.action, {
                        method: "POST",
                        body: new FormData(item.form),
                        credentials: "same-origin",
                        headers: { "X-Requested-With": "XMLHttpRequest" },
                    });

                    if (!response.ok) throw new Error("Task completion update failed");

                    const completedNow = pendingValue === "1";
                    hiddenInput.value = completedNow ? "0" : "1";
                    submitBtn.textContent = completedNow ? "Done" : "Mark Done";
                    submitBtn.classList.toggle("btn-success", completedNow);
                    submitBtn.classList.toggle("btn-outline-primary", !completedNow);
                    item.toggle.classList.toggle("is-done", completedNow);
                    window.sessionStorage.setItem(activeKey, item.taskId);
                } catch (error) {
                    item.form.submit();
                    return;
                } finally {
                    submitBtn.disabled = false;
                    item.toggle.disabled = false;
                }
            });
        });

        window.addEventListener("resize", syncAllOrigins);
        window.addEventListener("load", syncAllOrigins);
        syncAllOrigins();
    })();
</script>
{% endif %}

{% endif %}

{% if section == "tests" %}
<section id="tests" class="page-card p-4 mb-4">
    <h3 class="h5 mb-3">Skill Tests</h3>
    {% set ready_items = dashboard.goal_skills | selectattr('ready_for_test') | list %}
    {% if ready_items %}
        <ul class="list-group">
            {% for item in ready_items %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>{{ item.skill_name }}</span>
                    <a class="btn btn-sm btn-primary" href="/students/{{ student.id }}/skills/{{ item.id }}/test">Take Test</a>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p class="text-muted mb-0">Complete all tasks for a skill to unlock its test.</p>
    {% endif %}
</section>
{% endif %}

{% if section == "doubtbot" %}
<section id="chatbot" class="page-card p-4 mb-4">
    <h3 class="h5 mb-3">Playlist Doubt Chatbot</h3>
    {% if dashboard.chatbot.enabled %}
        <p class="text-muted mb-3">
            Active skill: <strong>{{ dashboard.chatbot.active_skill.skill_name }}</strong> |
            Playlist: <strong>{{ dashboard.chatbot.selected_playlist.title }}</strong>
        </p>
        <form method="post" action="/students/{{ student.id }}/chat/send?section=doubtbot">
            <div class="mb-2">
                <textarea
                    class="form-control"
                    name="question"
                    rows="3"
                    maxlength="1000"
                    placeholder="Ask any doubt from this selected playlist..."
                    required
                ></textarea>
            </div>
            <button type="submit" class="btn btn-primary btn-sm">Ask Chatbot</button>
        </form>

        {% if dashboard.chatbot.messages %}
            <div class="chat-window mt-3">
                {% for item in dashboard.chatbot.messages %}
                    <div class="chat-bubble {% if item.role == 'user' %}chat-user{% else %}chat-assistant{% endif %}">
                        <div class="small fw-semibold mb-1">
                            {% if item.role == "user" %}You{% else %}AI Mentor{% endif %}
                        </div>
                        <div>{{ item.message_text | replace('\n', '<br>') | safe }}</div>
                        <div class="small text-muted mt-1">{{ item.created_at }}</div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-muted mt-3 mb-0">No chat yet. Ask your first doubt.</p>
        {% endif %}
    {% else %}
        <p class="text-muted mb-0">{{ dashboard.chatbot.reason }}</p>
    {% endif %}
</section>
{% endif %}

{% if section == "opportunities" %}
<section id="opportunities" class="page-card p-4 mb-4">
    <h3 class="h5 mb-3">Opportunities</h3>

    <ul class="nav nav-tabs mb-3" id="opportunityTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#eligible" type="button">Eligible Now</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#almost" type="button">Almost Eligible</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#soon" type="button">Coming Soon</button>
        </li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="eligible">
            {% set items = dashboard.opportunities.eligible_now %}
            {% include "partials/opportunity_bucket.html" %}
        </div>
        <div class="tab-pane fade" id="almost">
            {% set items = dashboard.opportunities.almost_eligible %}
            {% include "partials/opportunity_bucket.html" %}
        </div>
        <div class="tab-pane fade" id="soon">
            {% set items = dashboard.opportunities.coming_soon %}
            {% include "partials/opportunity_bucket.html" %}
        </div>
    </div>
</section>

<section class="page-card p-4 mb-4">
    <h3 class="h5 mb-3">Likely Eligible In Next 7 Days</h3>
    {% if dashboard.opportunity_forecast_7_days %}
        <div class="table-responsive">
            <table class="table align-middle">
                <thead>
                    <tr>
                        <th>Opportunity</th>
                        <th>Likely Eligible Date</th>
                        <th>Skills To Unlock</th>
                        <th>Deadline</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in dashboard.opportunity_forecast_7_days %}
                    <tr>
                        <td>
                            <div class="fw-semibold">{{ item.title }}</div>
                            <div class="small text-muted">{{ item.company }}{% if item.type %} | {{ item.type }}{% endif %}</div>
                            <a href="{{ item.url }}" target="_blank" rel="noreferrer">Open</a>
                        </td>
                        <td>{{ item.predicted_eligible_date }}</td>
                        <td>
                            <div class="skills-list">
                                {% for skill in item.skills_to_unlock %}
                                    <span class="skill-pill">{{ skill }}</span>
                                {% endfor %}
                            </div>
                        </td>
                        <td>{{ item.deadline or "Not specified" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p class="text-muted mb-0">No opportunities are projected to become eligible in the next 7 days yet.</p>
    {% endif %}
</section>
{% endif %}

{% endblock %}
