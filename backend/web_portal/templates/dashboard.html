{% extends "base.html" %}
{% block title %}Dashboard | CodeMap{% endblock %}
{% block body_class %}dashboard-page dashboard-section-{{ active_section if active_section else "roadmap" }}{% endblock %}
{% block page_styles %}
<link href="/static/css/dashboard.css?v={{ asset_version }}" rel="stylesheet">
{% endblock %}
{% block content %}
{% set section = active_section if active_section else "roadmap" %}
{% if section == "roadmap" %}
{% set completed_goal_names = dashboard.goal_skills
    | selectattr("status", "equalto", "completed")
    | map(attribute="skill_name")
    | map("lower")
    | list
%}
<section class="roadmap-view mb-4">
    <article class="page-card roadmap-hero-card">
        <div class="roadmap-hero-content">
            <div class="roadmap-hero-main">
                <p class="roadmap-hero-kicker">Current Goal</p>
                <h2 class="roadmap-hero-title">{{ dashboard.goal.goal_text }}</h2>
                <div class="roadmap-hero-meta">
                    <span class="roadmap-hero-meta-item">
                        <svg class="roadmap-meta-icon" viewBox="0 0 24 24" aria-hidden="true">
                            <rect x="3.5" y="4.5" width="17" height="16" rx="2.4"></rect>
                            <line x1="8" y1="3" x2="8" y2="7"></line>
                            <line x1="16" y1="3" x2="16" y2="7"></line>
                            <line x1="3.5" y1="9" x2="20.5" y2="9"></line>
                            <rect x="7.1" y="11.8" width="2.4" height="2.4" rx="0.45"></rect>
                            <rect x="10.8" y="11.8" width="2.4" height="2.4" rx="0.45"></rect>
                            <rect x="14.5" y="11.8" width="2.4" height="2.4" rx="0.45"></rect>
                        </svg>
                        Target: {{ dashboard.goal_target_date_display }}
                    </span>
                    {% if dashboard.goal_months_remaining is not none %}
                        <span class="roadmap-hero-meta-item">
                            <svg class="roadmap-meta-icon" viewBox="0 0 24 24" aria-hidden="true">
                                <path d="M7 3.5h10"></path>
                                <path d="M7 20.5h10"></path>
                                <path d="M8.2 3.5v3.2c0 1.8.98 3.45 2.58 4.37L12 11.75l1.22-.68c1.6-.92 2.58-2.57 2.58-4.37V3.5"></path>
                                <path d="M8.2 20.5v-3.2c0-1.8.98-3.45 2.58-4.37L12 12.25l1.22.68c1.6.92 2.58 2.57 2.58 4.37v3.2"></path>
                            </svg>
                            {{ dashboard.goal_months_remaining }} month{% if dashboard.goal_months_remaining != 1 %}s{% endif %} remaining
                        </span>
                    {% endif %}
                </div>
            </div>
            <div class="roadmap-hero-side">
                <div class="roadmap-hero-status">Active Goal</div>
            </div>
        </div>

        {% if error %}
            <div class="alert alert-danger mt-3 mb-0">{{ error }}</div>
        {% endif %}
        {% if dashboard.replan_info.applied %}
            <div class="alert alert-warning mt-3 mb-0">
                Roadmap auto-adjusted because {{ dashboard.replan_info.overdue_task_count }} task(s) were missed.
                {{ dashboard.replan_info.updated_task_count }} task(s) were rescheduled.
            </div>
        {% endif %}
    </article>

    <section class="roadmap-top-grid">
        <article class="page-card roadmap-progress-card-dark">
            <h3 class="roadmap-progress-heading">Progress</h3>
            <div class="roadmap-progress-body">
                <div class="roadmap-progress-ring" style="--progress-value: {{ '%.2f'|format(dashboard.progress.completion_percent) }};">
                    <div class="roadmap-progress-ring-center">
                        <span class="roadmap-progress-ring-main">{{ dashboard.progress.completed_tasks }}</span>
                        <span class="roadmap-progress-ring-sub">of {{ dashboard.progress.total_tasks }}</span>
                    </div>
                </div>
                <div class="roadmap-progress-copy">
                    <p class="roadmap-progress-percent">{{ "%.0f"|format(dashboard.progress.completion_percent) }}%</p>
                    <p class="roadmap-progress-label">Task Completion</p>
                    <div class="roadmap-progress-track">
                        <div class="roadmap-progress-fill" style="--progress-value: {{ '%.2f'|format(dashboard.progress.completion_percent) }};"></div>
                    </div>
                </div>
            </div>
        </article>

        <article class="page-card roadmap-panel-card">
            <h3 class="roadmap-panel-ribbon">Skill Gap</h3>
            {% if dashboard.goal_skills %}
                <div class="roadmap-chip-list">
                    {% for skill in dashboard.goal_skills %}
                        <span class="roadmap-chip
                            {% if skill.status == 'completed' %}is-completed{% endif %}
                            {% if skill.is_locked %}is-locked{% endif %}
                        ">
                            {% if skill.is_locked %}<span class="roadmap-chip-icon" aria-hidden="true">&#128274;</span>{% endif %}
                            {{ skill.skill_name }}
                            {% if skill.status == "completed" %}<span class="roadmap-chip-icon roadmap-chip-check" aria-hidden="true">&#10003;</span>{% endif %}
                        </span>
                    {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-success mb-0">You currently meet all extracted requirements.</div>
            {% endif %}
        </article>

        <article class="page-card roadmap-panel-card">
            <h3 class="roadmap-panel-ribbon">Required Skills (LLM + Opportunity)</h3>
            {% if dashboard.required_skills %}
                <div class="roadmap-chip-list">
                    {% for skill in dashboard.required_skills %}
                        <span class="roadmap-chip">{{ skill }}</span>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted mb-0">No required skills extracted.</p>
            {% endif %}
        </article>
    </section>

    <article class="page-card roadmap-panel-card roadmap-current-card">
        <h3 class="roadmap-panel-ribbon">Your Current Skills</h3>
        {% if dashboard.known_skills %}
            <div class="roadmap-chip-list">
                {% for skill in dashboard.known_skills %}
                    {% set skill_key = skill | lower %}
                    <span class="roadmap-chip {% if skill_key in completed_goal_names %}is-completed{% endif %}">
                        {{ skill }}
                        {% if skill_key in completed_goal_names %}<span class="roadmap-chip-icon roadmap-chip-check" aria-hidden="true">&#10003;</span>{% endif %}
                    </span>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-muted mb-0">No profile skills found.</p>
        {% endif %}
    </article>
</section>
{% endif %}

{% if section != "roadmap" and error %}
<section class="page-card p-3 mb-4">
    <div class="alert alert-danger mb-0">{{ error }}</div>
</section>
{% endif %}

{% if dashboard.company_job_invites %}
<section class="page-card p-3 mb-4">
    <h3 class="h6 mb-3">Company Invitations</h3>
    <div class="company-invite-grid">
        {% for invite in dashboard.company_job_invites %}
            <article class="company-invite-card">
                <div class="company-invite-head">
                    <h4 class="company-invite-title mb-0">{{ invite.title }}</h4>
                    <span class="company-invite-company">{{ invite.company_username }}</span>
                </div>
                <p class="company-invite-copy">{{ invite.job_description }}</p>
                <div class="company-invite-meta">
                    <span><strong>Skills:</strong> {{ invite.required_skill_labels | join(", ") }}</span>
                    <span><strong>Min CGPA:</strong> {{ "%.1f"|format(invite.min_cgpa) }}</span>
                    <span><strong>Deadline:</strong> {{ invite.application_deadline }}</span>
                </div>
                {% if invite.deadline_passed %}
                    <p class="text-danger small mb-0 mt-2">This invitation has expired.</p>
                {% else %}
                    <div class="company-invite-actions">
                        <form
                            method="post"
                            action="/students/{{ student.id }}/company-jobs/{{ invite.job_id }}/respond?section={{ section }}"
                        >
                            <input type="hidden" name="decision" value="apply">
                            <button type="submit" class="btn btn-sm replan-btn">Apply</button>
                        </form>
                        <form
                            method="post"
                            action="/students/{{ student.id }}/company-jobs/{{ invite.job_id }}/respond?section={{ section }}"
                        >
                            <input type="hidden" name="decision" value="decline">
                            <button type="submit" class="btn btn-sm btn-outline-secondary">Decline</button>
                        </form>
                    </div>
                {% endif %}
            </article>
        {% endfor %}
    </div>
</section>
{% endif %}

{% if section == "tasks" %}
{% set active_goal_skill = (dashboard.goal_skills | selectattr('is_active') | list | first) %}
{% if active_goal_skill and active_goal_skill.ready_for_test %}
<section class="page-card p-3 mb-4">
    <div class="alert alert-warning mb-0">
        Give test to proceed further.
    </div>
</section>
{% endif %}

<section id="tasks" class="page-card p-4 mb-4">
    <div class="tasks-section-ribbon">Upcoming Tasks</div>
    {% if dashboard.active_skill and not dashboard.selected_playlist %}
        <div class="alert alert-info">
            Select one playlist for <strong>{{ dashboard.active_skill.skill_name }}</strong> first.
            Task completion will unlock after selection.
        </div>
    {% elif dashboard.upcoming_tasks %}
        <div id="tasksTimeline" class="tasks-timeline">
            <div class="tasks-timeline-track">
                {% set open_state = namespace(default_open_done=False) %}
                {% for task in dashboard.upcoming_tasks %}
                    {% set date_parts = (task.task_date | string).split('-') %}
                    {% if date_parts | length == 3 %}
                        {% set date_label = date_parts[2] ~ '/' ~ date_parts[1] ~ '/' ~ date_parts[0][-2:] %}
                    {% else %}
                        {% set date_label = task.task_date %}
                    {% endif %}

                    {% set details = namespace(url="", watch="", playlist="", channel="", extras=[]) %}
                    {% for raw_line in (task.description or "").split('\n') %}
                        {% set line = raw_line.strip() %}
                        {% if line %}
                            {% if line.lower().startswith('url:') %}
                                {% set details.url = line[4:].strip() %}
                            {% elif line.lower().startswith('watch videos') %}
                                {% if ':' in line %}
                                    {% set details.watch = line.split(':', 1)[1].strip() %}
                                {% else %}
                                    {% set details.watch = line[12:].strip() %}
                                {% endif %}
                            {% elif line.lower().startswith('playlist:') %}
                                {% set details.playlist = line[9:].strip() %}
                            {% elif line.lower().startswith('channel:') %}
                                {% set details.channel = line[8:].strip() %}
                            {% else %}
                                {% set _ = details.extras.append(line) %}
                            {% endif %}
                        {% endif %}
                    {% endfor %}

                    {% set open_default = false %}
                    {% if not open_state.default_open_done and task.task_date == dashboard.today %}
                        {% set open_default = true %}
                        {% set open_state.default_open_done = true %}
                    {% elif not open_state.default_open_done and loop.first %}
                        {% set open_default = true %}
                        {% set open_state.default_open_done = true %}
                    {% endif %}

                    <article class="task-node{% if open_default %} is-open{% endif %}" data-task-node data-task-id="{{ task.id }}">
                        <button
                            type="button"
                            class="task-date-rect{% if open_default %} is-active{% endif %}{% if task.is_completed == 1 %} is-done{% endif %}"
                            data-task-toggle
                            aria-expanded="{{ 'true' if open_default else 'false' }}"
                            aria-controls="task-card-{{ task.id }}"
                        >
                            {{ date_label }}
                        </button>

                        <section
                            id="task-card-{{ task.id }}"
                            class="task-detail-panel{% if open_default %} is-visible{% endif %}"
                            data-task-panel
                            {% if not open_default %}hidden{% endif %}
                        >
                            <header class="task-detail-header">
                                <h4 class="task-detail-title mb-0">{{ task.title }}</h4>
                            </header>

                            <div class="task-detail-body">
                                <div class="task-detail-topline">
                                    <span class="task-detail-target"><strong>TARGET:</strong> {{ task.target_minutes }} min</span>
                                </div>

                                {% if details.watch %}
                                    <p class="task-detail-row">
                                        <span class="task-detail-key">WATCH VIDEOS:</span>
                                        <span class="task-detail-value">{{ details.watch }}</span>
                                    </p>
                                {% endif %}

                                {% if details.playlist %}
                                    <p class="task-detail-row">
                                        <span class="task-detail-key">PLAYLIST:</span>
                                        <span class="task-detail-value">{{ details.playlist }}</span>
                                    </p>
                                {% endif %}

                                {% if details.channel %}
                                    <p class="task-detail-row">
                                        <span class="task-detail-key">CHANNEL:</span>
                                        <span class="task-detail-value">{{ details.channel }}</span>
                                    </p>
                                {% endif %}

                                {% if details.extras %}
                                    {% for line in details.extras %}
                                        <p class="task-detail-line">{{ line }}</p>
                                    {% endfor %}
                                {% endif %}

                                {% if not details.watch and not details.playlist and not details.channel and not details.extras %}
                                    <p class="task-detail-line">No details are available for this task.</p>
                                {% endif %}

                                <div class="task-detail-actions">
                                    {% if details.url %}
                                        <a href="{{ details.url }}" target="_blank" rel="noreferrer" class="btn btn-sm replan-btn task-playlist-btn">
                                            Open Playlist
                                        </a>
                                    {% else %}
                                        <span></span>
                                    {% endif %}

                                    <form
                                        method="post"
                                        action="/students/{{ student.id }}/tasks/{{ task.id }}/completion?section=tasks"
                                        class="task-detail-action"
                                        data-task-complete-form
                                    >
                                        <input type="hidden" name="is_completed" value="{% if task.is_completed == 1 %}0{% else %}1{% endif %}">
                                        <button type="submit" class="btn btn-sm {% if task.is_completed == 1 %}btn-success{% else %}btn-outline-primary{% endif %}">
                                            {% if task.is_completed == 1 %}Done{% else %}Mark Done{% endif %}
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </section>
                    </article>
                {% endfor %}
            </div>
        </div>
    {% else %}
        <p class="text-muted mb-0">No tasks in current window.</p>
    {% endif %}
</section>

{% if dashboard.upcoming_tasks %}
<script>
    (function () {
        const activeKey = "tasksTimeline.activeTaskId";
        const timeline = document.getElementById("tasksTimeline");
        if (!timeline) return;

        const entries = Array.from(timeline.querySelectorAll("[data-task-node]")).map((node) => {
            return {
                taskId: node.getAttribute("data-task-id"),
                node,
                toggle: node.querySelector("[data-task-toggle]"),
                panel: node.querySelector("[data-task-panel]"),
                form: node.querySelector("[data-task-complete-form]"),
            };
        }).filter((item) => item.toggle && item.panel && item.taskId);

        if (!entries.length) return;

        function syncOrigin(item) {
            const { toggle, panel } = item;
            const panelRect = panel.getBoundingClientRect();
            const toggleRect = toggle.getBoundingClientRect();
            if (!panelRect.width || !panelRect.height || !toggleRect.width || !toggleRect.height) return;
            const originX = toggleRect.left + (toggleRect.width / 2) - panelRect.left;
            const originY = toggleRect.top + (toggleRect.height / 2) - panelRect.top;
            panel.style.setProperty("--task-origin-x", `${originX}px`);
            panel.style.setProperty("--task-origin-y", `${originY}px`);
        }

        function syncAllOrigins() {
            entries.forEach(syncOrigin);
        }

        function openEntry(item) {
            const { node, toggle, panel } = item;
            panel.hidden = false;
            panel.classList.remove("closing");
            syncOrigin(item);
            window.requestAnimationFrame(() => {
                syncOrigin(item);
                void panel.offsetWidth;
                panel.classList.add("is-visible");
                node.classList.add("is-open");
                toggle.classList.add("is-active");
                toggle.setAttribute("aria-expanded", "true");
                window.sessionStorage.setItem(activeKey, item.taskId);
            });
        }

        function closeEntry(item) {
            return new Promise((resolve) => {
                const { node, toggle, panel } = item;
                if (panel.hidden || panel.classList.contains("closing")) {
                    resolve();
                    return;
                }

                panel.classList.remove("is-visible");
                panel.classList.add("closing");
                node.classList.remove("is-open");
                toggle.classList.remove("is-active");
                toggle.setAttribute("aria-expanded", "false");

                panel.addEventListener(
                    "animationend",
                    (event) => {
                        if (event.animationName !== "task-detail-panel-close") return;
                        panel.hidden = true;
                        panel.classList.remove("closing");
                        resolve();
                    },
                    { once: true },
                );
            });
        }

        function setActiveInstant(item) {
            entries.forEach((entry) => {
                const isTarget = entry === item;
                entry.panel.classList.remove("closing");
                entry.panel.classList.toggle("is-visible", isTarget);
                entry.panel.hidden = !isTarget;
                entry.node.classList.toggle("is-open", isTarget);
                entry.toggle.classList.toggle("is-active", isTarget);
                entry.toggle.setAttribute("aria-expanded", isTarget ? "true" : "false");
            });
            if (item) {
                syncOrigin(item);
                window.sessionStorage.setItem(activeKey, item.taskId);
            }
        }

        const savedTaskId = window.sessionStorage.getItem(activeKey);
        let activeEntry =
            entries.find((item) => item.taskId === savedTaskId) ||
            entries.find((item) => item.panel.classList.contains("is-visible")) ||
            entries[0];

        if (activeEntry) {
            setActiveInstant(activeEntry);
        }

        entries.forEach((item) => {
            item.toggle.addEventListener("click", async () => {
                if (item === activeEntry && item.panel.classList.contains("is-visible")) return;
                if (activeEntry && activeEntry !== item) {
                    await closeEntry(activeEntry);
                }
                openEntry(item);
                activeEntry = item;
            });

            item.form?.addEventListener("submit", async (event) => {
                event.preventDefault();
                const hiddenInput = item.form.querySelector("input[name='is_completed']");
                const submitBtn = item.form.querySelector("button[type='submit']");
                if (!hiddenInput || !submitBtn) {
                    item.form.submit();
                    return;
                }

                const pendingValue = hiddenInput.value;
                submitBtn.disabled = true;
                item.toggle.disabled = true;

                try {
                    const response = await fetch(item.form.action, {
                        method: "POST",
                        body: new FormData(item.form),
                        credentials: "same-origin",
                        headers: { "X-Requested-With": "XMLHttpRequest" },
                    });

                    if (!response.ok) throw new Error("Task completion update failed");

                    const completedNow = pendingValue === "1";
                    hiddenInput.value = completedNow ? "0" : "1";
                    submitBtn.textContent = completedNow ? "Done" : "Mark Done";
                    submitBtn.classList.toggle("btn-success", completedNow);
                    submitBtn.classList.toggle("btn-outline-primary", !completedNow);
                    item.toggle.classList.toggle("is-done", completedNow);
                    window.sessionStorage.setItem(activeKey, item.taskId);
                } catch (error) {
                    item.form.submit();
                    return;
                } finally {
                    submitBtn.disabled = false;
                    item.toggle.disabled = false;
                }
            });
        });

        window.addEventListener("resize", syncAllOrigins);
        window.addEventListener("load", syncAllOrigins);
        syncAllOrigins();
    })();
</script>
{% endif %}

{% endif %}

{% if section == "tests" %}
<section id="tests" class="page-card dashboard-tests-card p-0 mb-4">
    <h3 class="dashboard-tests-ribbon">Skill Tests</h3>
    <div class="dashboard-tests-content">
    {% set ready_items = dashboard.goal_skills | selectattr('ready_for_test') | list %}
    {% if ready_items %}
        <ul class="list-group">
            {% for item in ready_items %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>{{ item.skill_name }}</span>
                    <a class="btn btn-sm btn-primary" href="/students/{{ student.id }}/skills/{{ item.id }}/test">Take Test</a>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p class="text-muted mb-0">Complete all tasks for a skill to unlock its test.</p>
    {% endif %}

    <hr class="my-4">
    <h4 class="h6 mb-3">Test History</h4>
    {% if dashboard.test_history %}
        <div class="table-responsive">
            <table class="table align-middle dashboard-test-history-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Skill</th>
                        <th>Attempt</th>
                        <th>Submitted At</th>
                        <th>Score</th>
                        <th>Result</th>
                        <th>Review</th>
                    </tr>
                </thead>
                <tbody>
                    {% for attempt in dashboard.test_history %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ attempt.skill_name }}</td>
                        <td>{{ attempt.display_attempt_no }}</td>
                        <td>{{ attempt.submitted_at or "-" }}</td>
                        <td class="{% if attempt.passed == 1 %}test-score-passed{% elif attempt.passed == 0 %}test-score-failed{% endif %}">{{ attempt.score_display }}</td>
                        <td>
                            {% if attempt.passed == 1 %}
                                <span class="badge test-result-badge is-passed">Passed</span>
                            {% elif attempt.passed == 0 %}
                                <span class="badge test-result-badge is-failed">Failed</span>
                            {% else %}
                                <span class="badge test-result-badge is-pending">Pending</span>
                            {% endif %}
                        </td>
                        <td>
                            <a
                                class="btn btn-sm btn-outline-primary"
                                href="/students/{{ student.id }}/skills/tests/{{ attempt.id }}/result"
                            >
                                View
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p class="text-muted mb-0">No test attempts yet. Your attempts will appear here chronologically.</p>
    {% endif %}
    </div>
</section>
{% endif %}

{% if section == "doubtbot" %}
<section id="chatbot" class="page-card p-4 mb-4">
    <h3 class="h5 mb-3">Playlist Doubt Chatbot</h3>
    {% if dashboard.chatbot.enabled %}
        <p class="text-muted mb-3">
            Active skill: <strong>{{ dashboard.chatbot.active_skill.skill_name }}</strong> |
            Playlist: <strong>{{ dashboard.chatbot.selected_playlist.title }}</strong>
        </p>
        <form method="post" action="/students/{{ student.id }}/chat/send?section=doubtbot">
            <div class="mb-2">
                <textarea
                    class="form-control"
                    name="question"
                    rows="3"
                    maxlength="1000"
                    placeholder="Ask any doubt from this selected playlist..."
                    required
                ></textarea>
            </div>
            <button type="submit" class="btn btn-primary btn-sm">Ask Chatbot</button>
        </form>

        {% if dashboard.chatbot.messages %}
            <div class="chat-window mt-3">
                {% for item in dashboard.chatbot.messages %}
                    <div class="chat-bubble {% if item.role == 'user' %}chat-user{% else %}chat-assistant{% endif %}">
                        <div class="small fw-semibold mb-1">
                            {% if item.role == "user" %}You{% else %}AI Mentor{% endif %}
                        </div>
                        <div>{{ item.message_text | replace('\n', '<br>') | safe }}</div>
                        <div class="small text-muted mt-1">{{ item.created_at }}</div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-muted mt-3 mb-0">No chat yet. Ask your first doubt.</p>
        {% endif %}
    {% else %}
        <p class="text-muted mb-0">{{ dashboard.chatbot.reason }}</p>
    {% endif %}
</section>
{% endif %}

{% if section == "opportunities" %}
{% set eligible_count = dashboard.opportunities.eligible_now | length %}
{% set almost_count = dashboard.opportunities.almost_eligible | length %}
{% set soon_count = dashboard.opportunities.coming_soon | length %}
<section id="opportunities" class="opportunities-view mb-4">
    <div class="opportunities-head">
        <div class="opportunities-head-copy">
            <h3 class="opportunities-title">Opportunities</h3>
            <p class="opportunities-subtitle">Roles matched to your skills and goal company</p>
        </div>

        <div class="opportunities-head-actions">
            <button
                type="button"
                id="opportunityFilterToggle"
                class="opportunity-filter-toggle"
                aria-expanded="false"
                aria-controls="opportunityFilterPanel"
            >
                <span class="opportunity-filter-toggle-icon" aria-hidden="true"></span>
                Filters
            </button>

            <ul class="nav nav-tabs opportunities-switcher" id="opportunityTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#eligible" type="button">
                        Eligible Now
                        <span class="opportunities-switcher-count">{{ eligible_count }}</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#almost" type="button">
                        Almost Eligible
                        <span class="opportunities-switcher-count">{{ almost_count }}</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#soon" type="button">
                        Coming Soon
                        <span class="opportunities-switcher-count">{{ soon_count }}</span>
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <section id="opportunityFilterPanel" class="opportunity-filter-panel" hidden>
        <div class="opportunity-filter-panel-inner">
            <p class="opportunity-filter-kicker">Filter Opportunities</p>

            <div class="opportunity-filter-grid">
                <label class="opportunity-filter-field">
                    <span>Type</span>
                    <input
                        id="opportunityTypeFilter"
                        class="opportunity-filter-input opportunity-filter-input-dropdown"
                        type="text"
                        placeholder="All Types"
                        autocomplete="off"
                    >
                    <div id="opportunityTypeSuggestions" class="opportunity-suggestion-box" hidden></div>
                </label>

                <label class="opportunity-filter-field">
                    <span>Work Mode</span>
                    <input
                        id="opportunityWorkModeFilter"
                        class="opportunity-filter-input opportunity-filter-input-dropdown"
                        type="text"
                        placeholder="All Modes"
                        autocomplete="off"
                    >
                    <div id="opportunityWorkModeSuggestions" class="opportunity-suggestion-box" hidden></div>
                </label>
            </div>

            <p class="opportunity-filter-location-label">Location</p>
            <div class="opportunity-filter-grid opportunity-filter-grid-location">
                <label class="opportunity-filter-field">
                    <span>Country</span>
                    <input
                        id="opportunityCountryFilter"
                        class="opportunity-filter-input"
                        type="text"
                        placeholder="Type country"
                        autocomplete="off"
                    >
                    <div id="opportunityCountrySuggestions" class="opportunity-suggestion-box" hidden></div>
                </label>

                <label class="opportunity-filter-field">
                    <span>State</span>
                    <input
                        id="opportunityStateFilter"
                        class="opportunity-filter-input"
                        type="text"
                        placeholder="Type state"
                        autocomplete="off"
                    >
                    <div id="opportunityStateSuggestions" class="opportunity-suggestion-box" hidden></div>
                </label>

                <label class="opportunity-filter-field">
                    <span>City</span>
                    <input
                        id="opportunityCityFilter"
                        class="opportunity-filter-input"
                        type="text"
                        placeholder="Type city"
                        autocomplete="off"
                    >
                    <div id="opportunityCitySuggestions" class="opportunity-suggestion-box" hidden></div>
                </label>
            </div>

            <div class="opportunity-filter-actions">
                <button type="button" id="opportunityFilterReset" class="btn btn-sm btn-outline-secondary">Reset</button>
                <button type="button" id="opportunityFilterDone" class="opportunity-filter-done-btn">Done</button>
            </div>
        </div>
    </section>

    <div class="tab-content opportunities-tab-content">
        <div class="tab-pane fade show active" id="eligible">
            {% set items = dashboard.opportunities.eligible_now %}
            {% set bucket_label = "Eligible Now" %}
            {% set bucket_key = "eligible_now" %}
            {% include "partials/opportunity_bucket.html" %}

            <section class="opportunity-forecast-card mb-4">
                <header class="opportunity-forecast-ribbon">
                    <h3 class="opportunity-forecast-ribbon-title">Likely Eligible In Next 7 Days</h3>
                    <span class="opportunity-forecast-ribbon-meta">Based on your roadmap pace</span>
                </header>
                <div class="opportunity-forecast-body">
                    {% if dashboard.opportunity_forecast_7_days %}
                        <div class="opportunity-forecast-grid">
                            {% for item in dashboard.opportunity_forecast_7_days %}
                            <article class="opportunity-forecast-item">
                                <div class="opportunity-forecast-pill">Likely by {{ item.predicted_eligible_date }}</div>
                                <h4 class="opportunity-forecast-title">{{ item.title }}</h4>
                                <p class="opportunity-forecast-meta">{{ item.company }}{% if item.type %} &middot; {{ item.type }}{% endif %}</p>
                                <p class="opportunity-forecast-copy">
                                    {% if item.skills_to_unlock %}
                                        Unlock
                                        {% for skill in item.skills_to_unlock[:2] %}
                                            <span class="opportunity-inline-pill">{{ skill }}</span>
                                        {% endfor %}
                                        {% if item.skills_to_unlock|length > 2 %}+{{ item.skills_to_unlock|length - 2 }}{% endif %}
                                    {% else %}
                                        Keep current roadmap pace to unlock this role.
                                    {% endif %}
                                </p>
                            </article>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">No opportunities are projected to become eligible in the next 7 days yet.</p>
                    {% endif %}
                </div>
            </section>
        </div>
        <div class="tab-pane fade" id="almost">
            {% set items = dashboard.opportunities.almost_eligible %}
            {% set bucket_label = "Almost Eligible" %}
            {% set bucket_key = "almost_eligible" %}
            {% include "partials/opportunity_bucket.html" %}
        </div>
        <div class="tab-pane fade" id="soon">
            {% set items = dashboard.opportunities.coming_soon %}
            {% set bucket_label = "Coming Soon" %}
            {% set bucket_key = "coming_soon" %}
            {% include "partials/opportunity_bucket.html" %}
        </div>
    </div>
</section>

<script>
    (function () {
        const root = document.getElementById("opportunities");
        if (!root) return;
        const studentId = {{ student.id | tojson }};

        const filterToggle = document.getElementById("opportunityFilterToggle");
        const filterPanel = document.getElementById("opportunityFilterPanel");
        const filterDone = document.getElementById("opportunityFilterDone");
        const filterReset = document.getElementById("opportunityFilterReset");
        const typeFilter = document.getElementById("opportunityTypeFilter");
        const workModeFilter = document.getElementById("opportunityWorkModeFilter");
        const countryFilter = document.getElementById("opportunityCountryFilter");
        const stateFilter = document.getElementById("opportunityStateFilter");
        const cityFilter = document.getElementById("opportunityCityFilter");
        const typeList = document.getElementById("opportunityTypeSuggestions");
        const workModeList = document.getElementById("opportunityWorkModeSuggestions");
        const countryList = document.getElementById("opportunityCountrySuggestions");
        const stateList = document.getElementById("opportunityStateSuggestions");
        const cityList = document.getElementById("opportunityCitySuggestions");

        if (
            !filterToggle ||
            !filterPanel ||
            !filterDone ||
            !filterReset ||
            !typeFilter ||
            !workModeFilter ||
            !countryFilter ||
            !stateFilter ||
            !cityFilter ||
            !typeList ||
            !workModeList ||
            !countryList ||
            !stateList ||
            !cityList
        ) {
            return;
        }

        const cards = Array.from(root.querySelectorAll(".opportunity-card"));
        if (!cards.length) return;

        function normalize(value) {
            return String(value || "").trim().toLowerCase();
        }

        function titleCase(value) {
            const normalized = String(value || "").trim();
            if (!normalized) return "";
            return normalized
                .split(/\s+/)
                .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
                .join(" ");
        }

        function prettyLabel(value) {
            return titleCase(String(value || "").replace(/[_-]+/g, " "));
        }

        const FILTER_PANEL_TRANSITION_MS = 170;
        let filterPanelCloseTimer = 0;

        function setFilterPanelOpen(open) {
            if (filterPanelCloseTimer) {
                window.clearTimeout(filterPanelCloseTimer);
                filterPanelCloseTimer = 0;
            }

            if (open) {
                filterPanel.removeAttribute("hidden");
                window.requestAnimationFrame(() => {
                    filterPanel.classList.add("is-visible");
                });
                filterToggle.classList.add("is-open");
                filterToggle.setAttribute("aria-expanded", "true");
                return;
            }
            filterPanel.classList.remove("is-visible");
            filterToggle.classList.remove("is-open");
            filterToggle.setAttribute("aria-expanded", "false");
            hideSuggestionBox(typeList);
            hideSuggestionBox(workModeList);
            hideSuggestionBox(countryList);
            hideSuggestionBox(stateList);
            hideSuggestionBox(cityList);
            filterPanelCloseTimer = window.setTimeout(() => {
                filterPanel.setAttribute("hidden", "");
                filterPanelCloseTimer = 0;
            }, FILTER_PANEL_TRANSITION_MS);
        }

        function collectUniqueValues(selector) {
            const valueSet = new Set();
            cards.forEach((card) => {
                const value = normalize(card.dataset[selector] || "");
                if (value && value !== "unknown" && value !== "any") {
                    valueSet.add(value);
                }
            });
            return Array.from(valueSet).sort();
        }

        const typeOptions = [
            { value: "all", label: "All Types" },
            ...collectUniqueValues("oppType").map((value) => ({
                value,
                label: prettyLabel(value),
            })),
        ];

        const workModeSet = new Set(["remote", "hybrid", "on-site"]);
        collectUniqueValues("workMode").forEach((value) => workModeSet.add(value));
        const workModeOptions = [
            { value: "all", label: "All Modes" },
            ...Array.from(workModeSet)
                .sort()
                .map((value) => ({
                    value,
                    label: prettyLabel(value),
                })),
        ];

        function setFilterInputOption(inputEl, option) {
            inputEl.dataset.selected = option.value;
            inputEl.value = option.label;
        }

        function findFilterOption(options, value) {
            const target = normalize(value);
            if (!target) return null;
            return (
                options.find((option) => normalize(option.value) === target) ||
                options.find((option) => normalize(option.label) === target) ||
                null
            );
        }

        function resolveFilterInputValue(inputEl, options) {
            const typed = normalize(inputEl.value);
            if (!typed) return "all";
            const matched = findFilterOption(options, typed);
            if (matched) return matched.value;
            const selected = normalize(inputEl.dataset.selected);
            if (selected) return selected;
            return typed;
        }

        function filterLocalOptions(options, query) {
            const normalizedQuery = normalize(query);
            if (!normalizedQuery) return options;

            const startsWith = [];
            const contains = [];

            options.forEach((option) => {
                const byLabel = normalize(option.label);
                const byValue = normalize(option.value);
                if (byLabel.startsWith(normalizedQuery) || byValue.startsWith(normalizedQuery)) {
                    startsWith.push(option);
                    return;
                }
                if (byLabel.includes(normalizedQuery) || byValue.includes(normalizedQuery)) {
                    contains.push(option);
                }
            });

            return startsWith.concat(contains);
        }

        setFilterInputOption(typeFilter, typeOptions[0]);
        setFilterInputOption(workModeFilter, workModeOptions[0]);

        function buildSuggestionUrl(kind, params = {}) {
            const search = new URLSearchParams();
            Object.entries(params).forEach(([key, rawValue]) => {
                const value = String(rawValue || "").trim();
                if (value) search.set(key, value);
            });
            return `/students/${studentId}/locations/${kind}?${search.toString()}`;
        }

        const suggestionCache = new Map();

        async function fetchSuggestions(kind, params = {}) {
            const normalizedParams = {};
            Object.entries(params).forEach(([key, rawValue]) => {
                const value = String(rawValue || "").trim();
                if (value) normalizedParams[key] = value;
            });

            if (kind !== "countries" && !normalizedParams.country) return [];
            if (kind === "cities" && !normalizedParams.state) return [];

            const cacheKey = `${kind}:${JSON.stringify(normalizedParams).toLowerCase()}`;
            if (suggestionCache.has(cacheKey)) {
                return suggestionCache.get(cacheKey) || [];
            }

            try {
                const response = await fetch(buildSuggestionUrl(kind, normalizedParams), {
                    credentials: "same-origin",
                    headers: { "X-Requested-With": "XMLHttpRequest" },
                });
                if (!response.ok) return [];

                const payload = await response.json();
                const items = Array.isArray(payload.items)
                    ? payload.items.map((item) => String(item || "").trim()).filter(Boolean)
                    : [];
                suggestionCache.set(cacheKey, items);
                return items;
            } catch (_error) {
                return [];
            }
        }

        let countryToken = 0;
        let stateToken = 0;
        let cityToken = 0;

        function refreshTypeSuggestions() {
            const options = filterLocalOptions(typeOptions, typeFilter.value);
            renderStaticSuggestionBox(typeList, options, (option) => {
                setFilterInputOption(typeFilter, option);
                hideSuggestionBox(typeList);
                applyFilters();
            });
        }

        function refreshWorkModeSuggestions() {
            const options = filterLocalOptions(workModeOptions, workModeFilter.value);
            renderStaticSuggestionBox(workModeList, options, (option) => {
                setFilterInputOption(workModeFilter, option);
                hideSuggestionBox(workModeList);
                applyFilters();
            });
        }

        async function refreshCountrySuggestions() {
            const requestToken = ++countryToken;
            const items = await fetchSuggestions("countries", {
                q: countryFilter.value,
                limit: 10000,
            });
            if (requestToken !== countryToken) return;
            renderSuggestionBox(countryList, items, (value) => {
                countryFilter.value = value;
                stateFilter.value = "";
                cityFilter.value = "";
                hideSuggestionBox(countryList);
                applyFilters();
                void refreshStateSuggestions();
                void refreshCitySuggestions();
            });
        }

        async function refreshStateSuggestions() {
            if (!String(countryFilter.value || "").trim()) {
                hideSuggestionBox(stateList);
                return;
            }
            const requestToken = ++stateToken;
            const items = await fetchSuggestions("states", {
                country: countryFilter.value,
                q: stateFilter.value,
                limit: 10000,
            });
            if (requestToken !== stateToken) return;
            renderSuggestionBox(stateList, items, (value) => {
                stateFilter.value = value;
                cityFilter.value = "";
                hideSuggestionBox(stateList);
                applyFilters();
                void refreshCitySuggestions();
            });
        }

        async function refreshCitySuggestions() {
            if (!String(countryFilter.value || "").trim() || !String(stateFilter.value || "").trim()) {
                hideSuggestionBox(cityList);
                return;
            }
            const requestToken = ++cityToken;
            const items = await fetchSuggestions("cities", {
                country: countryFilter.value,
                state: stateFilter.value,
                q: cityFilter.value,
                limit: 10000,
            });
            if (requestToken !== cityToken) return;
            renderSuggestionBox(cityList, items, (value) => {
                cityFilter.value = value;
                hideSuggestionBox(cityList);
                applyFilters();
            });
        }

        async function hasExactLocation(kind, value, extraParams = {}) {
            const query = String(value || "").trim();
            if (!query) return false;
            const items = await fetchSuggestions(kind, {
                ...extraParams,
                q: query,
                limit: 50,
            });
            const target = normalize(query);
            return items.some((item) => normalize(item) === target);
        }

        function refreshBucketEmptyStates() {
            const bucketBodies = root.querySelectorAll(".opportunity-bucket-body");
            bucketBodies.forEach((bucketBody) => {
                const allCards = Array.from(bucketBody.querySelectorAll(".opportunity-card"));
                const visibleCards = allCards.filter((card) => !card.hidden);
                const emptyNode = bucketBody.querySelector(".opportunity-filter-empty");
                if (emptyNode) {
                    emptyNode.hidden = visibleCards.length !== 0;
                }
            });
        }

        function refreshTabCounts() {
            const tabButtons = root.querySelectorAll(".opportunities-switcher .nav-link[data-bs-target]");
            tabButtons.forEach((button) => {
                const target = button.getAttribute("data-bs-target");
                if (!target || !target.startsWith("#")) return;
                const pane = root.querySelector(target);
                if (!pane) return;
                const count = pane.querySelectorAll(".opportunity-card:not([hidden])").length;
                const countNode = button.querySelector(".opportunities-switcher-count");
                if (countNode) countNode.textContent = String(count);
            });
        }

        function applyFilters() {
            const selectedType = normalize(resolveFilterInputValue(typeFilter, typeOptions));
            const selectedWorkMode = normalize(resolveFilterInputValue(workModeFilter, workModeOptions));
            const selectedCountry = normalize(countryFilter.value);
            const selectedState = normalize(stateFilter.value);
            const selectedCity = normalize(cityFilter.value);

            cards.forEach((card) => {
                const cardType = normalize(card.dataset.oppType);
                const cardWorkMode = normalize(card.dataset.workMode);
                const cardCountry = normalize(card.dataset.country);
                const cardState = normalize(card.dataset.state);
                const cardCity = normalize(card.dataset.city);

                const typeMatches = selectedType === "all" || cardType.startsWith(selectedType);
                const workModeMatches = selectedWorkMode === "all" || cardWorkMode.startsWith(selectedWorkMode);
                const countryMatches = !selectedCountry || cardCountry.startsWith(selectedCountry);
                const stateMatches = !selectedState || cardState.startsWith(selectedState);
                const cityMatches = !selectedCity || cardCity.startsWith(selectedCity);

                card.hidden = !(typeMatches && workModeMatches && countryMatches && stateMatches && cityMatches);
            });

            refreshBucketEmptyStates();
            refreshTabCounts();
        }

        function applyFiltersAndSuggestions() {
            applyFilters();
            if (document.activeElement === typeFilter) {
                refreshTypeSuggestions();
                return;
            }
            if (document.activeElement === workModeFilter) {
                refreshWorkModeSuggestions();
                return;
            }
            if (document.activeElement === countryFilter) {
                void refreshCountrySuggestions();
                return;
            }
            if (document.activeElement === stateFilter) {
                void refreshStateSuggestions();
                return;
            }
            if (document.activeElement === cityFilter) {
                void refreshCitySuggestions();
                return;
            }
            hideSuggestionBox(typeList);
            hideSuggestionBox(workModeList);
            hideSuggestionBox(countryList);
            hideSuggestionBox(stateList);
            hideSuggestionBox(cityList);
        }

        const suggestionTimers = new Map();

        function hideSuggestionBox(box) {
            box.classList.remove("is-visible");
            box.setAttribute("hidden", "");
            box.innerHTML = "";
        }

        function renderStaticSuggestionBox(box, options, onSelect) {
            box.innerHTML = "";
            if (!options.length) {
                hideSuggestionBox(box);
                return;
            }

            options.forEach((option) => {
                const button = document.createElement("button");
                button.type = "button";
                button.className = "opportunity-suggestion-item";
                button.textContent = option.label;
                button.addEventListener("mousedown", (event) => {
                    event.preventDefault();
                    onSelect(option);
                });
                box.appendChild(button);
            });

            box.removeAttribute("hidden");
            window.requestAnimationFrame(() => {
                box.classList.add("is-visible");
            });
        }

        function renderSuggestionBox(box, values, onSelect) {
            box.innerHTML = "";
            if (!values.length) {
                hideSuggestionBox(box);
                return;
            }

            values.forEach((value) => {
                const button = document.createElement("button");
                button.type = "button";
                button.className = "opportunity-suggestion-item";
                button.textContent = value;
                button.addEventListener("mousedown", (event) => {
                    event.preventDefault();
                    onSelect(value);
                });
                box.appendChild(button);
            });

            box.removeAttribute("hidden");
            window.requestAnimationFrame(() => {
                box.classList.add("is-visible");
            });
        }

        function scheduleSuggestionHide(box) {
            const existing = suggestionTimers.get(box);
            if (existing) window.clearTimeout(existing);
            const timer = window.setTimeout(() => hideSuggestionBox(box), 120);
            suggestionTimers.set(box, timer);
        }

        function cancelSuggestionHide(box) {
            const existing = suggestionTimers.get(box);
            if (existing) window.clearTimeout(existing);
            suggestionTimers.delete(box);
        }

        function bindSuggestionFocus(input, box) {
            input.addEventListener("blur", () => scheduleSuggestionHide(box));
            input.addEventListener("focus", () => cancelSuggestionHide(box));
            box.addEventListener("mouseenter", () => cancelSuggestionHide(box));
            box.addEventListener("mouseleave", () => scheduleSuggestionHide(box));
        }

        bindSuggestionFocus(typeFilter, typeList);
        bindSuggestionFocus(workModeFilter, workModeList);
        bindSuggestionFocus(countryFilter, countryList);
        bindSuggestionFocus(stateFilter, stateList);
        bindSuggestionFocus(cityFilter, cityList);

        filterToggle.addEventListener("click", () => {
            const shouldOpen = filterPanel.hasAttribute("hidden");
            setFilterPanelOpen(shouldOpen);
        });

        filterDone.addEventListener("click", () => setFilterPanelOpen(false));

        filterReset.addEventListener("click", () => {
            setFilterInputOption(typeFilter, typeOptions[0]);
            setFilterInputOption(workModeFilter, workModeOptions[0]);
            countryFilter.value = "";
            stateFilter.value = "";
            cityFilter.value = "";
            applyFiltersAndSuggestions();
        });

        typeFilter.addEventListener("input", () => {
            typeFilter.dataset.selected = "";
            applyFilters();
            refreshTypeSuggestions();
            hideSuggestionBox(workModeList);
        });

        workModeFilter.addEventListener("input", () => {
            workModeFilter.dataset.selected = "";
            applyFilters();
            refreshWorkModeSuggestions();
            hideSuggestionBox(typeList);
        });

        countryFilter.addEventListener("input", () => {
            applyFilters();
            void refreshCountrySuggestions();
            hideSuggestionBox(stateList);
            hideSuggestionBox(cityList);
        });

        stateFilter.addEventListener("input", () => {
            applyFilters();
            void refreshStateSuggestions();
            hideSuggestionBox(cityList);
        });

        cityFilter.addEventListener("input", () => {
            applyFilters();
            void refreshCitySuggestions();
        });

        typeFilter.addEventListener("focus", () => {
            refreshTypeSuggestions();
        });

        workModeFilter.addEventListener("focus", () => {
            refreshWorkModeSuggestions();
        });

        countryFilter.addEventListener("focus", () => {
            void refreshCountrySuggestions();
        });

        stateFilter.addEventListener("focus", () => {
            void refreshStateSuggestions();
        });

        cityFilter.addEventListener("focus", () => {
            void refreshCitySuggestions();
        });

        typeFilter.addEventListener("change", () => {
            const matched = findFilterOption(typeOptions, typeFilter.value);
            if (matched) {
                setFilterInputOption(typeFilter, matched);
            } else if (!String(typeFilter.value || "").trim()) {
                setFilterInputOption(typeFilter, typeOptions[0]);
            }
            applyFiltersAndSuggestions();
        });

        workModeFilter.addEventListener("change", () => {
            const matched = findFilterOption(workModeOptions, workModeFilter.value);
            if (matched) {
                setFilterInputOption(workModeFilter, matched);
            } else if (!String(workModeFilter.value || "").trim()) {
                setFilterInputOption(workModeFilter, workModeOptions[0]);
            }
            applyFiltersAndSuggestions();
        });

        countryFilter.addEventListener("change", async () => {
            const countryMatches = await hasExactLocation("countries", countryFilter.value);
            if (!countryMatches) {
                stateFilter.value = "";
                cityFilter.value = "";
            } else {
                const stateMatches = await hasExactLocation("states", stateFilter.value, {
                    country: countryFilter.value,
                });
                if (!stateMatches) cityFilter.value = "";
            }
            applyFiltersAndSuggestions();
        });

        stateFilter.addEventListener("change", async () => {
            const stateMatches = await hasExactLocation("states", stateFilter.value, {
                country: countryFilter.value,
            });
            if (!stateMatches) cityFilter.value = "";
            applyFiltersAndSuggestions();
        });

        cityFilter.addEventListener("change", applyFiltersAndSuggestions);

        document.addEventListener("mousedown", (event) => {
            if (filterPanel.hasAttribute("hidden")) return;
            if (!typeFilter.contains(event.target) && !typeList.contains(event.target)) {
                hideSuggestionBox(typeList);
            }
            if (!workModeFilter.contains(event.target) && !workModeList.contains(event.target)) {
                hideSuggestionBox(workModeList);
            }
            if (!countryFilter.contains(event.target) && !countryList.contains(event.target)) {
                hideSuggestionBox(countryList);
            }
            if (!stateFilter.contains(event.target) && !stateList.contains(event.target)) {
                hideSuggestionBox(stateList);
            }
            if (!cityFilter.contains(event.target) && !cityList.contains(event.target)) {
                hideSuggestionBox(cityList);
            }
            if (filterPanel.contains(event.target) || filterToggle.contains(event.target)) return;
            setFilterPanelOpen(false);
        });

        applyFilters();
    })();
</script>
{% endif %}

{% endblock %}
