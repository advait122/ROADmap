<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}CodeMap{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/base.css?v={{ asset_version }}" rel="stylesheet">
    {% block page_styles %}{% endblock %}
</head>
<body class="{% block body_class %}{% endblock %}">
    <nav class="navbar navbar-expand-lg bg-white border-bottom mb-4">
        <div class="container">
            <a href="/" class="navbar-brand fw-semibold text-decoration-none">CodeMap</a>
            {% if student %}
                {% set dashboard_url = "/students/" ~ student.id ~ "/dashboard" %}
                {% set current_section = active_section if active_section else "roadmap" %}
                {% set notification_items = [] %}
                {% if dashboard is defined and dashboard and dashboard.notifications is defined %}
                    {% set notification_items = dashboard.notifications %}
                {% endif %}
                {% set year_suffix = {1: 'st', 2: 'nd', 3: 'rd'}.get(student.current_year, 'th') %}
                <div class="ribbon-nav" role="navigation" aria-label="Dashboard Sections">
                    <a href="{{ dashboard_url }}?section=roadmap" class="ribbon-link {% if current_section == 'roadmap' %}active{% endif %}">Progress Dashboard</a>
                    <a href="{{ dashboard_url }}?section=tasks" class="ribbon-link {% if current_section == 'tasks' %}active{% endif %}">Tasks</a>
                    <a href="{{ dashboard_url }}?section=tests" class="ribbon-link {% if current_section == 'tests' %}active{% endif %}">Tests</a>
                    <a href="{{ dashboard_url }}?section=doubtbot" class="ribbon-link {% if current_section == 'doubtbot' %}active{% endif %}">DoubtBot</a>
                    <a href="{{ dashboard_url }}?section=opportunities" class="ribbon-link {% if current_section == 'opportunities' %}active{% endif %}">Opportunities</a>
                </div>
                <div class="topbar-actions">
                    <div class="notification-shell">
                        <button
                            type="button"
                            class="notification-toggle"
                            id="notificationToggle"
                            aria-label="Open notifications"
                            aria-expanded="false"
                        >
                            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                                <path d="M18 8a6 6 0 0 0-12 0c0 7-3 9-3 9h18s-3-2-3-9"></path>
                                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                            </svg>
                            {% if notification_items %}
                                <span class="notification-badge">{{ notification_items | length }}</span>
                            {% endif %}
                        </button>
                        <div
                            class="notification-panel"
                            id="notificationPanel"
                            aria-hidden="true"
                        >
                            <div class="notification-panel-header">Notifications</div>
                            <div class="notification-panel-body">
                                {% if notification_items %}
                                    {% for note in notification_items %}
                                        <details class="notification-item">
                                            <summary class="notification-item-summary">
                                                <span class="notification-item-title">{{ note.ui_title or note.title }}</span>
                                                <span class="notification-item-chevron" aria-hidden="true">&#8250;</span>
                                            </summary>
                                            <div class="notification-item-detail">
                                                {% if note.ui_link_text and note.ui_link_url %}
                                                    {{ note.ui_detail_prefix or "" }}
                                                    <a
                                                        href="{{ note.ui_link_url }}"
                                                        target="_blank"
                                                        rel="noreferrer"
                                                        class="notification-item-link"
                                                    >
                                                        {{ note.ui_link_text }}
                                                    </a>
                                                    {{ note.ui_detail_suffix or "" }}
                                                {% else %}
                                                    {{ note.ui_detail or note.body }}
                                                {% endif %}
                                            </div>
                                        </details>
                                    {% endfor %}
                                {% else %}
                                    <p class="notification-empty">No notifications yet.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="profile-shell">
                        <button
                            type="button"
                            class="profile-toggle"
                            id="profileToggle"
                            aria-label="Open profile info"
                            aria-expanded="false"
                        >
                            <svg viewBox="0 0 16 16" aria-hidden="true" focusable="false">
                                <path d="M8 8.5A2.5 2.5 0 1 0 8 3.5a2.5 2.5 0 0 0 0 5Zm-4.25 3c0-1.2 1.32-2.25 4.25-2.25s4.25 1.05 4.25 2.25V12H3.75v-.5ZM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-7a7 7 0 1 0 0 14A7 7 0 0 0 8 1Z"/>
                            </svg>
                        </button>
                        <div
                            class="profile-panel"
                            id="profilePanel"
                            aria-hidden="true"
                        >
                            <p class="profile-panel-line"><span class="profile-label">Name:</span> {{ student.name }}</p>
                            <p class="profile-panel-line"><span class="profile-label">Branch:</span> {{ student.branch }}</p>
                            <p class="profile-panel-line"><span class="profile-label">Year:</span> {{ student.current_year }}{{ year_suffix }} Year</p>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </nav>

    <main class="container pb-5">
        {% block content %}{% endblock %}
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (function () {
            const notificationToggle = document.getElementById("notificationToggle");
            const notificationPanel = document.getElementById("notificationPanel");
            const profileToggle = document.getElementById("profileToggle");
            const profilePanel = document.getElementById("profilePanel");

            function setPanelState(toggle, panel, isOpen) {
                if (!toggle || !panel) return;
                panel.classList.toggle("show", isOpen);
                panel.setAttribute("aria-hidden", isOpen ? "false" : "true");
                toggle.setAttribute("aria-expanded", isOpen ? "true" : "false");
            }

            function closeAllPanels() {
                setPanelState(notificationToggle, notificationPanel, false);
                setPanelState(profileToggle, profilePanel, false);
            }

            if (notificationToggle && notificationPanel) {
                notificationToggle.addEventListener("click", (event) => {
                    event.stopPropagation();
                    const open = !notificationPanel.classList.contains("show");
                    setPanelState(notificationToggle, notificationPanel, open);
                    if (open) setPanelState(profileToggle, profilePanel, false);
                });
            }

            if (profileToggle && profilePanel) {
                profileToggle.addEventListener("click", (event) => {
                    event.stopPropagation();
                    const open = !profilePanel.classList.contains("show");
                    setPanelState(profileToggle, profilePanel, open);
                    if (open) setPanelState(notificationToggle, notificationPanel, false);
                });
            }

            document.addEventListener("click", (event) => {
                const target = event.target;
                if (!(target instanceof Element)) return;
                const insideNotification = Boolean(
                    notificationPanel && notificationPanel.contains(target)
                ) || Boolean(
                    notificationToggle && notificationToggle.contains(target)
                );
                const insideProfile = Boolean(
                    profilePanel && profilePanel.contains(target)
                ) || Boolean(
                    profileToggle && profileToggle.contains(target)
                );
                if (!insideNotification && !insideProfile) closeAllPanels();
            });

            document.addEventListener("keydown", (event) => {
                if (event.key === "Escape") closeAllPanels();
            });
        })();
    </script>
</body>
</html>
